name: Workflow integration test

on:
  pull_request:
  workflow_dispatch:
    inputs:
      CICD_TEST_MODE:
        required: false
        default: ""
        type: string

env:
  CICD_TEST_MODE: ${{ github.event.inputs.CICD_TEST_MODE || '' }}

jobs:
  integration-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Resolve CICD workflow ref
        run: |
          workflow_ref="${{ github.workflow_ref }}"
          if [ -n "${workflow_ref}" ]; then
            repo="${workflow_ref%%/.github/workflows/*}"
            ref="${workflow_ref##*@}"
          else
            repo="${GITHUB_REPOSITORY}"
            ref="${GITHUB_REF_NAME}"
          fi
          {
            echo "CICD_REPO=${repo}"
            echo "CICD_REF=${ref}"
          } >> "$GITHUB_ENV"
          scripts_dir=""
          repo_dir=""
          if [ -d "${GITHUB_WORKSPACE}/.github/scripts" ]; then
            repo_dir="${GITHUB_WORKSPACE}"
            scripts_dir="${GITHUB_WORKSPACE}/.github/scripts"
          elif [ -d "/github/workspace/.github/scripts" ]; then
            repo_dir="/github/workspace"
            scripts_dir="/github/workspace/.github/scripts"
          elif [ -d "$(pwd)/.github/scripts" ]; then
            repo_dir="$(pwd)"
            scripts_dir="$(pwd)/.github/scripts"
          fi
          if [ -n "${scripts_dir}" ] && [ "${repo}" = "${GITHUB_REPOSITORY}" ]; then
            {
              echo "CICD_REPO_DIR=${repo_dir}"
              echo "CICD_SCRIPTS_DIR=${scripts_dir}"
              echo "CICD_NEED_CHECKOUT=false"
            } >> "$GITHUB_ENV"
          else
            {
              echo "CICD_REPO_DIR=${GITHUB_WORKSPACE}/.cicd"
              echo "CICD_SCRIPTS_DIR=${GITHUB_WORKSPACE}/.cicd/.github/scripts"
              echo "CICD_NEED_CHECKOUT=true"
            } >> "$GITHUB_ENV"
          fi
      - name: Checkout CICD scripts
        uses: actions/checkout@v4
        if: env.CICD_NEED_CHECKOUT == 'true'
        with:
          repository: ${{ env.CICD_REPO }}
          ref: ${{ env.CICD_REF }}
          token: ${{ secrets.GITHUB_TOKEN || secrets.GH_TOKEN || github.token }}
          path: .cicd
          fetch-depth: 1

      - name: Install dependencies for helper script
        run: pip3 install dockerfile-parse pyyaml --break-system-packages

      - name: Import versions from main workflow
        run: |
          python3 "$CICD_SCRIPTS_DIR/export_workflow_env.py" \
            --workflow "$CICD_REPO_DIR/.github/workflows/github.yaml" \
            --keys NVCHECKER_VERSION DFUPDATE_VERSION

      - name: Show imported versions
        run: |
          echo "NVCHECKER_VERSION=${NVCHECKER_VERSION:-<unset>}"
          echo "DFUPDATE_VERSION=${DFUPDATE_VERSION:-<unset>}"

      - name: Prepare sample workspace
        working-directory: integration-test
        run: rm -f new_ver.json

      - name: Run nvchecker on sample config
        if: env.CICD_TEST_MODE != 'true'
        working-directory: integration-test
        run: docker run --rm --name nvchecker-integration --mount "type=bind,source=${PWD},target=/data/" -w /data "snw35/nvchecker:${NVCHECKER_VERSION}" nvchecker -l debug -c nvchecker.toml

      - name: Run dfupdate on sample Dockerfile
        if: env.CICD_TEST_MODE != 'true'
        working-directory: integration-test
        run: docker run --rm --name dfupdate-integration --mount "type=bind,source=${PWD},target=/data/" -w /data "snw35/dfupdate:${DFUPDATE_VERSION}"

      - name: Fix Dockerfile permissions
        if: env.CICD_TEST_MODE != 'true'
        working-directory: integration-test
        run: sudo chown "$(id -u):$(id -g)" Dockerfile

      - name: Run nvchecker on sample config (test mode)
        if: env.CICD_TEST_MODE == 'true'
        working-directory: integration-test
        run: |
          "${GITHUB_WORKSPACE}/tests/workflows/stubs/nvchecker.sh"

      - name: Run dfupdate on sample Dockerfile (test mode)
        if: env.CICD_TEST_MODE == 'true'
        working-directory: integration-test
        run: |
          "${GITHUB_WORKSPACE}/tests/workflows/stubs/dfupdate.sh"

      - name: Verify Dockerfile updated with discovered version
        working-directory: integration-test
        run: |
          EXPECTED="$(cat version.txt)"
          UPDATED="$(python3 "$CICD_SCRIPTS_DIR/dockerfile_envs.py" get SAMPLE_VERSION)"
          echo "Expected SAMPLE_VERSION=${EXPECTED}"
          echo "Updated SAMPLE_VERSION=${UPDATED}"
          if [ "${UPDATED}" != "${EXPECTED}" ]; then
            echo "Integration test failed: Dockerfile SAMPLE_VERSION not updated"
            exit 1
          fi
