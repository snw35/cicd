name: Workflow integration test

on:
  pull_request:
  workflow_dispatch:
    inputs:
      CICD_TEST_MODE:
        required: false
        default: ""
        type: string

env:
  CICD_TEST_MODE: ${{ github.event.inputs.CICD_TEST_MODE || '' }}

jobs:
  integration-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/resolve-cicd

      - name: Install dependencies for helper script
        run: pip3 install dockerfile-parse pyyaml --break-system-packages

      - name: Import versions from main workflow
        run: |
          python3 "$CICD_SCRIPTS_DIR/export_workflow_env.py" \
            --workflow "$CICD_REPO_DIR/.github/workflows/github.yaml" \
            --keys NVCHECKER_VERSION DFUPDATE_VERSION

      - name: Show imported versions
        run: |
          echo "NVCHECKER_VERSION=${NVCHECKER_VERSION:-<unset>}"
          echo "DFUPDATE_VERSION=${DFUPDATE_VERSION:-<unset>}"

      - name: Prepare sample workspace
        working-directory: integration-test
        run: rm -f new_ver.json

      - name: Run nvchecker on sample config
        if: env.CICD_TEST_MODE != 'true'
        working-directory: integration-test
        run: docker run --rm --name nvchecker-integration --mount "type=bind,source=${PWD},target=/data/" -w /data "snw35/nvchecker:${NVCHECKER_VERSION}" nvchecker -l debug -c nvchecker.toml

      - name: Run dfupdate on sample Dockerfile
        if: env.CICD_TEST_MODE != 'true'
        working-directory: integration-test
        run: docker run --rm --name dfupdate-integration --mount "type=bind,source=${PWD},target=/data/" -w /data "snw35/dfupdate:${DFUPDATE_VERSION}"

      - name: Fix Dockerfile permissions
        if: env.CICD_TEST_MODE != 'true'
        working-directory: integration-test
        run: sudo chown "$(id -u):$(id -g)" Dockerfile

      - name: Run nvchecker on sample config (test mode)
        if: env.CICD_TEST_MODE == 'true'
        working-directory: integration-test
        run: |
          "${GITHUB_WORKSPACE}/tests/workflows/stubs/nvchecker.sh"

      - name: Run dfupdate on sample Dockerfile (test mode)
        if: env.CICD_TEST_MODE == 'true'
        working-directory: integration-test
        run: |
          "${GITHUB_WORKSPACE}/tests/workflows/stubs/dfupdate.sh"

      - name: Verify Dockerfile updated with discovered version
        working-directory: integration-test
        run: |
          EXPECTED="$(cat version.txt)"
          UPDATED="$(python3 "$CICD_SCRIPTS_DIR/dockerfile_envs.py" get SAMPLE_VERSION)"
          echo "Expected SAMPLE_VERSION=${EXPECTED}"
          echo "Updated SAMPLE_VERSION=${UPDATED}"
          if [ "${UPDATED}" != "${EXPECTED}" ]; then
            echo "Integration test failed: Dockerfile SAMPLE_VERSION not updated"
            exit 1
          fi
